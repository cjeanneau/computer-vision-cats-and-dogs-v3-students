# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š PROMETHEUS CONFIGURATION - Collecte de mÃ©triques MLOps
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ OBJECTIF PÃ‰DAGOGIQUE
# Fichier de configuration central de Prometheus dÃ©finissant QUOI scraper, QUAND,
# et COMMENT stocker les mÃ©triques. Illustre les concepts de service discovery,
# scraping intervals, et architecture de monitoring.
#
# ğŸ“š CONCEPTS CLÃ‰S
# - Scraping pull-based : Prometheus interroge les targets (vs push comme StatsD)
# - Jobs : groupes logiques de targets (ex: tous les workers d'une app)
# - Service discovery : dÃ©tection automatique vs static_configs
# - Retention : durÃ©e de conservation des time-series (dÃ©faut : 15 jours)
#
# ğŸ”— FICHIERS LIÃ‰S
# - src/monitoring/prometheus_metrics.py : expose les mÃ©triques Ã  scraper
# - docker-compose.yml : monte ce fichier dans /etc/prometheus/
# - monitoring/grafana/ : consomme ces mÃ©triques pour dashboards
#
# ğŸ“– DOCUMENTATION COMPLÃˆTE
# https://prometheus.io/docs/prometheus/latest/configuration/configuration/
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸŒ CONFIGURATION GLOBALE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
global:
  scrape_interval: 15s
  # â±ï¸ Intervalle par dÃ©faut entre chaque scrape (15 secondes)
  # 
  # ğŸ’¡ CHOIX DE L'INTERVALLE
  # - 15s : standard Prometheus (bon compromis rÃ©solution/charge)
  # - 5s : haute frÃ©quence (apps critiques, forte charge rÃ©seau)
  # - 60s : basse frÃ©quence (batch jobs, Ã©conomie ressources)
  #
  # ğŸ“Š IMPACT SUR STOCKAGE
  # 100 mÃ©triques Ã— 15s scrape Ã— 30j retention â‰ˆ 17M datapoints
  # Ã€ 12 bytes/point â‰ˆ 200 MB (Prometheus compresse ~10x â†’ 20 MB rÃ©el)
  #
  # âš ï¸ COMPROMIS
  # Plus court = meilleure rÃ©solution temporelle mais plus de donnÃ©es
  # Plus long = moins prÃ©cis pour dÃ©tection anomalies rapides
  
  evaluation_interval: 15s
  # ğŸš¨ FrÃ©quence d'Ã©valuation des rÃ¨gles d'alerte (15 secondes)
  # 
  # ğŸ’¡ LOGIQUE
  # MÃªme intervalle que scrape_interval pour cohÃ©rence :
  # - Nouvelles donnÃ©es disponibles toutes les 15s
  # - RÃ¨gles Ã©valuÃ©es toutes les 15s
  # â†’ DÃ©lai dÃ©tection max = 15s (acceptable pour la plupart des cas)
  #
  # ğŸ“Š EXEMPLE RÃˆGLE
  # alert: HighLatency
  # expr: cv_inference_time_seconds > 2
  # for: 1m  # DÃ©clenche aprÃ¨s 1 min (4 Ã©valuations consÃ©cutives Ã  15s)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸš¨ RÃˆGLES D'ALERTING (commentÃ©es en V3)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# rule_files:
#   - "rules/*.yml"
# 
# ğŸ’¡ POURQUOI COMMENTÃ‰ ?
# En V3, alerting gÃ©rÃ© par Grafana Unified Alerting (plus avancÃ©) :
# - Multi-datasource (Prometheus + PostgreSQL)
# - Notification groups (Discord, Email, PagerDuty)
# - Silences et inhibitions sophistiquÃ©es
#
# ğŸ“ ALERTING PROMETHEUS NATIF (si dÃ©commentÃ©)
# Structure rules/*.yml :
#   groups:
#     - name: cv_alerts
#       rules:
#         - alert: ModelDegradation
#           expr: rate(cv_predictions_total{result="cat"}[5m]) < 0.3
#           for: 10m
#           annotations:
#             summary: "Cat predictions dropped below 30%"
#
# âš ï¸ LIMITATIONS ALERTING PROMETHEUS
# - Notifications limitÃ©es (Alertmanager requis)
# - Pas de jointure multi-datasources
# - Configuration yaml moins flexible que Grafana UI
#
# ğŸ”— MIGRATION VERS GRAFANA
# Si besoin de tester alertes Prometheus â†’ dÃ©commenter rule_files
# Mais en production : privilÃ©gier Grafana (cf. monitoring/grafana/provisioning/alerting/)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¯ SCRAPE CONFIGS - DÃ©finition des targets Ã  monitorer
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
scrape_configs:
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“Š JOB 1 : Application FastAPI (mÃ©triques mÃ©tier)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: 'cv-cats-dogs'
    # ğŸ·ï¸ Identifiant du job (apparaÃ®t comme label job="cv-cats-dogs")
    # Bonne pratique : nom descriptif de l'application
    
    static_configs:
      - targets: ['cv_app:8000']
        # ğŸŒ Endpoint Ã  scraper
        # Format : hostname:port (rÃ©solution DNS Docker Compose)
        # cv_app = nom du service dans docker-compose.yml
        # 8000 = port interne FastAPI (pas le port hÃ´te)
        #
        # ğŸ’¡ POURQUOI PAS localhost:8000 ?
        # localhost dans conteneur Prometheus = conteneur lui-mÃªme
        # cv_app = rÃ©solu par rÃ©seau Docker (cv_mlops_network)
        #
        # ğŸ“ STATIC vs DYNAMIC SERVICE DISCOVERY
        # static_configs : liste manuelle (simple, petite infra)
        # Alternatives dynamiques :
        # - consul_sd_configs : Consul service registry
        # - kubernetes_sd_configs : pods Kubernetes auto-dÃ©tectÃ©s
        # - file_sd_configs : fichier JSON/YAML externe (rechargÃ© auto)
    
    metrics_path: '/metrics'
    # ğŸ“ Endpoint HTTP exposant les mÃ©triques (standard Prometheus)
    # URL complÃ¨te scrapÃ©e : http://cv_app:8000/metrics
    # 
    # ğŸ’¡ CONVENTION PROMETHEUS
    # /metrics = endpoint par dÃ©faut (peut Ãªtre omis)
    # Contenu : format texte Prometheus (voir exemple ci-dessous)
    #
    # ğŸ“Š EXEMPLE RÃ‰PONSE /metrics
    # # HELP cv_predictions_total Total number of predictions
    # # TYPE cv_predictions_total counter
    # cv_predictions_total{result="cat"} 142.0
    # cv_predictions_total{result="dog"} 138.0
    # 
    # # HELP cv_inference_time_seconds Time spent on inference
    # # TYPE cv_inference_time_seconds histogram
    # cv_inference_time_seconds_bucket{le="0.1"} 45.0
    # cv_inference_time_seconds_bucket{le="0.5"} 120.0
    # cv_inference_time_seconds_sum 67.8
    # cv_inference_time_seconds_count 280.0
    
    scrape_interval: 10s
    # â±ï¸ Override de l'intervalle global (10s au lieu de 15s)
    # 
    # ğŸ’¡ POURQUOI PLUS FRÃ‰QUENT ?
    # Application principale avec mÃ©triques critiques :
    # - Latence d'infÃ©rence : dÃ©tection rapide de dÃ©gradation
    # - Taux d'erreur : alerte prÃ©coce si pic de failures
    # 
    # âš ï¸ COÃ›T
    # +50% de datapoints par rapport Ã  15s
    # Acceptable pour 1 target (faible charge rÃ©seau)
    # Ã€ Ã©viter si 100+ targets (prÃ©fÃ©rer 15-30s)
    
    # ğŸ“ LABELS AUTOMATIQUES AJOUTÃ‰S
    # Prometheus enrichit automatiquement chaque mÃ©trique :
    # - job="cv-cats-dogs"
    # - instance="cv_app:8000"
    # - __address__="cv_app:8000"  (interne, filtrÃ© Ã  l'export)
    #
    # ğŸ’¡ USAGE LABELS DANS QUERIES
    # cv_predictions_total{job="cv-cats-dogs", result="cat"}
    # rate(cv_inference_time_seconds_sum[5m]) / rate(cv_inference_time_seconds_count[5m])

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ” JOB 2 : Auto-monitoring Prometheus
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: 'prometheus'
    # ğŸ“Š MÃ©triques internes de Prometheus lui-mÃªme
    # 
    # ğŸ¯ MÃ‰TRIQUES EXPOSÃ‰ES
    # - prometheus_tsdb_storage_blocks_bytes : espace disque utilisÃ©
    # - prometheus_http_requests_total : nombre de requÃªtes API /query
    # - prometheus_rule_evaluations_total : Ã©valuations de rÃ¨gles
    # - prometheus_target_scrapes_exceeded_sample_limit_total : cibles avec trop de mÃ©triques
    #
    # ğŸ’¡ POURQUOI MONITORER PROMETHEUS ?
    # - DÃ©tecter saturation stockage (alerte si >80% disk)
    # - Identifier targets problÃ©matiques (timeouts, trop de sÃ©ries)
    # - Optimiser performances (queries lentes, cardinality Ã©levÃ©e)
    
    static_configs:
      - targets: ['localhost:9090']
        # ğŸ  localhost valide ici (mÃªme conteneur)
        # Prometheus scrape son propre endpoint /metrics
        #
        # ğŸ“ MÃ‰TRIQUES INTERNES UTILES
        # prometheus_tsdb_head_series : nombre de time-series actives
        #   â†’ Alerte si >1M (signe de cardinality explosion)
        # prometheus_tsdb_compactions_total : compactions rÃ©ussies
        #   â†’ Monitoring santÃ© du TSDB
        # up{job="prometheus"} : toujours 1 (auto-monitoring)

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ—„ï¸ JOB 3 : PostgreSQL (monitoring optionnel)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres:5432']
        # âš ï¸ ATTENTION : CONFIGURATION INCOMPLÃˆTE
        # PostgreSQL n'expose PAS nativement /metrics Prometheus
        # 
        # ğŸ’¡ SOLUTION : postgres_exporter
        # Sidecar container convertissant stats PostgreSQL â†’ format Prometheus
        # 
        # ğŸ”§ IMPLÃ‰MENTATION COMPLÃˆTE (Ã  ajouter)
        # Dans docker-compose.yml :
        #   postgres_exporter:
        #     image: quay.io/prometheuscommunity/postgres-exporter
        #     environment:
        #       DATA_SOURCE_NAME: "postgresql://user:pass@postgres:5432/db?sslmode=disable"
        #     ports:
        #       - "9187:9187"
        #
        # Dans prometheus.yml :
        #   - job_name: 'postgres'
        #     static_configs:
        #       - targets: ['postgres_exporter:9187']
        #
        # ğŸ“Š MÃ‰TRIQUES POSTGRES UTILES
        # - pg_stat_database_tup_inserted : lignes insÃ©rÃ©es (monitoring feedbacks)
        # - pg_stat_activity_count : connexions actives (dÃ©tection leaks)
        # - pg_database_size_bytes : taille DB (alertes croissance)
        # - pg_stat_statements_total_time_seconds : queries lentes
        #
        # ğŸ¯ CAS D'USAGE
        # - CorrÃ©lation : pics de prÃ©dictions â†” charge DB
        # - Optimisation : identifier queries gourmandes
        # - CapacitÃ© : prÃ©voir scaling si DB saturÃ©e
        #
        # âš ï¸ EN L'Ã‰TAT ACTUEL
        # Cette config ne fait rien (postgres:5432 ne rÃ©pond pas Ã  /metrics)
        # â†’ Retirer OU implÃ©menter postgres_exporter

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ CONCEPTS AVANCÃ‰S (non implÃ©mentÃ©s, pour aller plus loin)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. RELABELING (modification des labels)
#    scrape_configs:
#      - job_name: 'cv-app'
#        relabel_configs:
#          - source_labels: [__address__]
#            target_label: __param_target
#          - target_label: instance
#            replacement: 'production'
#    â†’ Utile pour renommer instances, filtrer mÃ©triques
#
# 2. AUTHENTICATION (scraping endpoints sÃ©curisÃ©s)
#    scrape_configs:
#      - job_name: 'secured-app'
#        basic_auth:
#          username: 'prometheus'
#          password: 'secret'
#        # OU bearer_token pour JWT
#    â†’ Scraping APIs avec authentification
#
# 3. HONOR LABELS (prÃ©server labels originaux)
#    scrape_configs:
#      - job_name: 'federated'
#        honor_labels: true
#    â†’ Important si scraping d'autres Prometheus (fÃ©dÃ©ration)
#
# 4. SAMPLE LIMIT (protection contre cardinality bombs)
#    scrape_configs:
#      - job_name: 'untrusted-app'
#        sample_limit: 1000
#    â†’ Rejette scrape si >1000 mÃ©triques (Ã©vite saturation)
#
# 5. METRIC RELABELING (filtrage post-scrape)
#    scrape_configs:
#      - job_name: 'app'
#        metric_relabel_configs:
#          - source_labels: [__name__]
#            regex: 'go_.*'
#            action: drop
#    â†’ Supprime mÃ©triques Go inutiles (Ã©conomise stockage)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› ï¸ COMMANDES UTILES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# VALIDATION CONFIG
#   promtool check config prometheus.yml
#   â†’ VÃ©rifie syntaxe YAML avant dÃ©ploiement
#
# RELOAD Ã€ CHAUD
#   curl -X POST http://localhost:9090/-/reload
#   â†’ Recharge config sans restart (si --web.enable-lifecycle activÃ©)
#
# VÃ‰RIFICATION TARGETS
#   http://localhost:9090/targets
#   â†’ UI web listant tous les jobs et leur statut (UP/DOWN)
#
# DEBUGGING SCRAPE
#   curl http://cv_app:8000/metrics
#   â†’ Simule un scrape (voir ce que Prometheus rÃ©cupÃ¨re)
#
# QUERIES DIAGNOSTIQUES
#   up{job="cv-cats-dogs"}  # Statut target (1=up, 0=down)
#   scrape_duration_seconds{job="cv-cats-dogs"}  # Temps scrape
#   scrape_samples_scraped{job="cv-cats-dogs"}  # Nombre mÃ©triques
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“š RESSOURCES PÃ‰DAGOGIQUES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# - Configuration reference: https://prometheus.io/docs/prometheus/latest/configuration/configuration/
# - Best practices: https://prometheus.io/docs/practices/naming/
# - Service discovery: https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config
# - postgres_exporter: https://github.com/prometheus-community/postgres_exporter
# - Relabeling guide: https://grafana.com/blog/2022/03/21/how-relabeling-in-prometheus-works/
