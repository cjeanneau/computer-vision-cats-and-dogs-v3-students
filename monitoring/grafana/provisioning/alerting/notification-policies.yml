# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”€ GRAFANA NOTIFICATION POLICIES - Routage des alertes
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ OBJECTIF
# DÃ©finit COMMENT et QUAND les alertes sont envoyÃ©es aux contact points.
# GÃ¨re grouping (regroupement), throttling (limitation) et routage par sÃ©vÃ©ritÃ©.
#
# ğŸ“š CONCEPTS CLÃ‰S
# - Receiver : contact point destination (Discord, Email, etc.)
# - Group by : regroupement d'alertes similaires (Ã©vite spam)
# - group_wait : dÃ©lai avant envoi 1Ã¨re notification (batch alertes)
# - group_interval : frÃ©quence envoi si nouvelles alertes dans groupe
# - repeat_interval : frÃ©quence rÃ©pÃ©tition si alerte non rÃ©solue
# - Routes : rÃ¨gles de routage conditionnelles (par label)
#
# ğŸ”— WORKFLOW
# Alert fires â†’ Match route â†’ Group â†’ Wait â†’ Send to receiver (Discord)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

apiVersion: 1

policies:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“‹ POLICY RACINE (default)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - orgId: 1
    # ğŸ¢ Organization ID (dÃ©faut : 1)
    
    receiver: Discord CV Alerts
    # ğŸ“¢ Contact point par dÃ©faut (dÃ©fini dans contact-points.yml)
    # UtilisÃ© si aucune route spÃ©cifique ne match
    
    group_by: ['alertname', 'grafana_folder']
    # ğŸ—‚ï¸ REGROUPEMENT DES ALERTES
    # Alertes avec mÃªmes labels sont groupÃ©es en 1 notification
    # 
    # ğŸ’¡ EXEMPLE
    # 3 alertes simultanÃ©es :
    # - HighLatency (folder: CV, alertname: HighLatency)
    # - HighLatency (folder: CV, alertname: HighLatency) [autre instance]
    # - DatabaseDisconnected (folder: CV, alertname: DatabaseDisconnected)
    # 
    # RÃ©sultat : 2 notifications Discord
    # 1. Groupe "HighLatency" : 2 alertes combinÃ©es
    # 2. Groupe "DatabaseDisconnected" : 1 alerte
    #
    # ğŸ¯ AVANTAGES
    # - RÃ©duit spam (pas 1 message par alerte)
    # - Contextualise (problÃ¨me affecte N instances)
    # - LisibilitÃ© Discord amÃ©liorÃ©e
    #
    # ğŸ“Š ALTERNATIVES
    # - group_by: [...] (vide) â†’ chaque alerte = notification sÃ©parÃ©e
    # - group_by: ['cluster', 'severity'] â†’ groupe par environnement + niveau
    
    group_wait: 10s
    # â±ï¸ DÃ‰LAI AVANT 1ÃˆRE NOTIFICATION
    # Attend 10s aprÃ¨s 1Ã¨re alerte du groupe avant envoi
    # 
    # ğŸ’¡ LOGIQUE
    # Si 3 alertes arrivent Ã  t=0s, t=2s, t=5s :
    # â†’ Attend jusqu'Ã  t=10s
    # â†’ Envoie 1 notification groupÃ©e (3 alertes)
    #
    # ğŸ¯ COMPROMIS
    # Court (10s) : rÃ©activitÃ© (notification rapide)
    # Long (60s) : batching efficace (mais dÃ©lai perceptible)
    
    group_interval: 5m
    # ğŸ”„ FRÃ‰QUENCE MISE Ã€ JOUR GROUPE
    # Si nouvelles alertes arrivent dans groupe existant : envoi notification toutes les 5 min
    # 
    # ğŸ’¡ SCÃ‰NARIO
    # t=0 : Alerte A fire â†’ notification Ã  t=10s
    # t=2m : Alerte B (mÃªme groupe) fire â†’ notification Ã  t=5m (depuis derniÃ¨re)
    # t=7m : Alerte C (mÃªme groupe) fire â†’ notification Ã  t=10m (5m aprÃ¨s t=5m)
    #
    # ğŸ¯ Ã‰VITE
    # - Flood Discord (nouvelles alertes = nouvelles notifs immÃ©diates)
    # - Permet updates rÃ©guliÃ¨res (Ã©quipe voit Ã©volution)
    
    repeat_interval: 12h
    # â™»ï¸ RÃ‰PÃ‰TITION SI NON RÃ‰SOLUE
    # Alerte firing non rÃ©solue â†’ rappel toutes les 12h
    # 
    # ğŸ’¡ SCÃ‰NARIO
    # t=0 : Alerte fire â†’ notification immÃ©diate
    # t=12h : Toujours firing â†’ notification rappel
    # t=24h : Toujours firing â†’ notification rappel
    # 
    # ğŸ¯ USAGE
    # - Ã‰vite oubli (problÃ¨me persistent = rappels)
    # - Pas trop frÃ©quent (12h vs 1h) pour Ã©viter lassitude
    # - Configurable par route (critical = rappels plus frÃ©quents)
    
    routes:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”´ ROUTE 1 : Alertes CRITICAL (haute prioritÃ©)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - receiver: Discord CV Alerts
        # ğŸ“¢ MÃªme receiver (Discord), mais timings diffÃ©rents
        
        object_matchers:
          - ['severity', '=', 'critical']
          # ğŸ¯ MATCHER : filtre alertes avec label severity=critical
          # Format : [label_name, operator, value]
          # OpÃ©rateurs : =, !=, =~, !~ (regex)
          # 
          # ğŸ’¡ ALERTES MATCHÃ‰ES (cf. cv-alerts.yml)
          # - DatabaseDisconnected (severity: critical)
          # 
          # ğŸ”— LIEN AVEC ALERT RULES
          # Les labels dÃ©finis dans cv-alerts.yml dÃ©terminent routing ici
        
        group_wait: 5s
        # âš¡ DÃ‰LAI RÃ‰DUIT (5s vs 10s default)
        # Critical = urgent â†’ notification quasi-immÃ©diate
        
        repeat_interval: 5m
        # ğŸ” RÃ‰PÃ‰TITION FRÃ‰QUENTE (5min vs 12h default)
        # Incident critique non rÃ©solu â†’ rappels agressifs
        # Objectif : maintenir pression pour rÃ©solution rapide
        # 
        # ğŸ’¡ EXEMPLE DB DISCONNECT
        # t=0 : DB down â†’ notification immÃ©diate
        # t=5m : Toujours down â†’ rappel (Ã©quipe voit Ã§a dure)
        # t=10m : Toujours down â†’ rappel (escalation suggÃ©rÃ©e)
        #
        # âš ï¸ ATTENTION FATIGUE
        # RÃ©pÃ©titions frÃ©quentes = efficace court terme
        # Si incident >1h non rÃ©solu â†’ considÃ©rer escalation manuelle
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸŸ¡ ROUTE 2 : Alertes WARNING (prioritÃ© moyenne)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - receiver: Discord CV Alerts
        object_matchers:
          - ['severity', '=', 'warning']
          # ğŸ¯ ALERTES MATCHÃ‰ES
          # - HighInferenceLatency (severity: warning)
        
        group_wait: 10s
        # â±ï¸ DÃ©lai standard (cohÃ©rent avec default)
        
        repeat_interval: 1h
        # ğŸ” Rappels modÃ©rÃ©s (1h)
        # Warning = dÃ©gradÃ© mais pas critique
        # Rappels suffisants pour tracking, pas spam
        # 
        # ğŸ’¡ EXEMPLE LATENCE Ã‰LEVÃ‰E
        # t=0 : Latence >2s â†’ notification
        # t=1h : Toujours lent â†’ rappel (vÃ©rifier si rÃ©solu)
        # t=2h : Toujours lent â†’ rappel (investigation plus profonde ?)
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # ğŸ”µ ROUTE 3 : Alertes INFO (prioritÃ© faible)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - receiver: Discord CV Alerts
        object_matchers:
          - ['severity', '=', 'info']
          # ğŸ¯ ALERTES MATCHÃ‰ES
          # - NoPredictionsActivity (severity: info)
        
        group_wait: 30s
        # â±ï¸ DÃ©lai long (30s)
        # Info = pas urgent, ok d'attendre pour grouper
        
        repeat_interval: 6h
        # ğŸ” Rappels espacÃ©s (6h)
        # Informatif, pas un problÃ¨me nÃ©cessitant action immÃ©diate
        # 
        # ğŸ’¡ EXEMPLE NO ACTIVITY
        # t=0 : Pas de prÃ©dictions depuis 15min â†’ notification
        # t=6h : Toujours inactif â†’ rappel (peut-Ãªtre weekend/nuit, normal)
        # t=12h : Toujours inactif â†’ rappel (investigation si anormal)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ STRATÃ‰GIES DE ROUTING AVANCÃ‰ES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# MULTI-RECEIVERS (par sÃ©vÃ©ritÃ©)
#   routes:
#     - receiver: discord-critical
#       object_matchers:
#         - ['severity', '=', 'critical']
#     - receiver: email-team
#       object_matchers:
#         - ['severity', '=', 'warning']
#   â†’ Critical â†’ Discord (temps rÃ©el)
#   â†’ Warning â†’ Email (async, moins intrusif)
#
# ROUTING PAR Ã‰QUIPE
#   routes:
#     - receiver: ml-team-discord
#       object_matchers:
#         - ['component', '=', 'model']
#     - receiver: infra-team-slack
#       object_matchers:
#         - ['component', '=', 'database']
#   â†’ Alertes modÃ¨le â†’ ML team
#   â†’ Alertes infra â†’ DevOps team
#
# HORAIRES (via silences, pas routes)
#   Notification policies ne supportent pas conditions temporelles
#   Utiliser Silences Grafana pour :
#   - DÃ©sactiver info alerts pendant heures bureau
#   - Muter warnings weekends
#   UI : Alerting â†’ Silences â†’ New silence
#
# ESCALATION (multi-receivers)
#   routes:
#     - receiver: discord-primary
#       object_matchers:
#         - ['severity', '=', 'critical']
#       continue: true  # Continue vers routes suivantes
#     - receiver: pagerduty-oncall
#       object_matchers:
#         - ['severity', '=', 'critical']
#       group_wait: 5m  # Escalade si non ack aprÃ¨s 5min
#   â†’ Critical envoie Ã  Discord ET PagerDuty
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› ï¸ TUNING DES TIMINGS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# FACTEURS Ã€ CONSIDÃ‰RER
#
# 1. VOLUME D'ALERTES
#    Peu d'alertes â†’ group_wait court (rÃ©activitÃ©)
#    Beaucoup d'alertes â†’ group_wait long (batching)
#
# 2. SLA / CRITICITÃ‰
#    Critical â†’ repeat_interval court (5-15min)
#    Info â†’ repeat_interval long (6-24h)
#
# 3. Ã‰QUIPE ON-CALL
#    Horaires bureau â†’ repeat_interval modÃ©rÃ©
#    24/7 on-call â†’ repeat_interval court (escalation rapide)
#
# 4. FATIGUE NOTIFICATION
#    Trop de rappels â†’ ignorÃ©s (cry wolf effect)
#    Calibrer selon temps rÃ©solution moyen observÃ©
#
# BONNES PRATIQUES
# - group_wait : 5s (urgent) Ã  60s (batch)
# - group_interval : 5-10min (updates rÃ©guliÃ¨res)
# - repeat_interval : 
#   * Critical : 5-30min
#   * Warning : 1-4h
#   * Info : 6-24h
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ TESTS ET MONITORING
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# TEST ROUTING
# 1. Forcer alerte (ex: docker compose stop postgres)
# 2. VÃ©rifier dans Grafana UI :
#    Alerting â†’ Alert rules â†’ DatabaseDisconnected â†’ State: Firing
# 3. Checker Discord : notification reÃ§ue ?
# 4. Timer : combien de temps entre fire et notification ?
#
# VÃ‰RIFICATION GROUPING
# Grafana UI â†’ Alerting â†’ Notification history
# - Voir groupes crÃ©Ã©s
# - Nombre d'alertes par notification
# - Timing envoi vs fire
#
# DEBUG ROUTING
# Grafana UI â†’ Alerting â†’ Notification policies
# - Preview routing avec labels simulÃ©s
# - Tester matchers (quelle route match ?)
#
# LOGS GRAFANA
# docker compose logs grafana | grep notification
# - "sending notification to discord"
# - "grouped N alerts"
# - Erreurs webhook Discord
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š MONITORING DES NOTIFICATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# MÃ‰TRIQUES Ã€ TRACKER
# - Nombre notifications envoyÃ©es / jour
# - Taux grouping (alertes / notifications)
# - DÃ©lai moyen notification (fire â†’ send)
# - Repeat notifications non rÃ©solues (fatigue ?)
#
# QUERIES PROMETHEUS (mÃ©triques Grafana internes)
# grafana_alerting_notifications_sent_total
# grafana_alerting_notification_latency_seconds
#
# DASHBOARD GRAFANA
# CrÃ©er dashboard monitoring du monitoring :
# - Alertes par sÃ©vÃ©ritÃ© (time series)
# - Notifications Discord par jour (counter)
# - MTTR (Mean Time To Resolution) par alerte
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“š RESSOURCES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# - Notification policies : https://grafana.com/docs/grafana/latest/alerting/manage-notifications/create-notification-policy/
# - Grouping : https://grafana.com/docs/grafana/latest/alerting/fundamentals/notification-policies/notifications/#grouping
# - Matchers : https://grafana.com/docs/grafana/latest/alerting/fundamentals/annotation-label/how-to-use-labels/
# - Best practices : https://grafana.com/docs/grafana/latest/alerting/set-up/provision-alerting-resources/
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•