
name: Deploy to VPS

on:
  push:
    branches:
      - main
    
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          
          chmod 600 ~/.ssh/id_ed25519
          
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        

      - name: ğŸ“¦ Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          STUDENT_ID: ${{ secrets.STUDENT_ID }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ssh $VPS_USER@$VPS_HOST bash << 'ENDSSH'
            set -e
            
            STUDENT_ID="${{ secrets.STUDENT_ID }}"
            REPO_NAME="${{ github.event.repository.name }}"
            PROJECT_DIR="$HOME/apps/${REPO_NAME}-${STUDENT_ID}"
            
            echo "ğŸ“ Dossier: $PROJECT_DIR"
            
            if [ -d "$PROJECT_DIR" ]; then
              cd "$PROJECT_DIR"
              git pull
            else
              cd $HOME/apps
              git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${REPO_NAME}-${STUDENT_ID}
              cd ${REPO_NAME}-${STUDENT_ID}
            fi
            
            echo "ğŸ“„ Copie du fichier .env..."
            cp $HOME/apps/.env.${STUDENT_ID} .env
            cp $HOME/apps/.env.${STUDENT_ID} docker/.env
            
            echo "ğŸ³ DÃ©ploiement Docker..."
            cd docker
            
            docker compose -p cv-${STUDENT_ID} down 2>/dev/null || true
            
            echo "ğŸ”¨ Build des images..."
            docker compose -p cv-${STUDENT_ID} build --no-cache
            
            echo "ğŸš€ DÃ©marrage des containers..."
            docker compose -p cv-${STUDENT_ID} up -d
            
            echo "â³ Attente du dÃ©marrage..."
            sleep 10
            
            echo "âœ… Ã‰tat des containers:"
            docker compose -p cv-${STUDENT_ID} ps
            
            echo "ğŸ§¹ Nettoyage..."
            docker image prune -af --filter "until=24h"
            
            echo "âœ… DÃ©ploiement terminÃ© pour ${STUDENT_ID}"
          ENDSSH

      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi pour ${{ secrets.STUDENT_ID }}"
          echo "ğŸ“Š Grafana: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_GRAFANA }}"
          echo "ğŸ”§ API: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_API }}"
          echo "ğŸ“ˆ Prometheus: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_PROMETHEUS }}"
          echo ""
          echo "ğŸ§ª Test de santÃ©:"
          curl -f http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_API }}/health || echo "âš ï¸  API pas encore prÃªte"

