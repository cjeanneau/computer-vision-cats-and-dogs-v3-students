#!/bin/bash

# Script de configuration initiale du monitoring V3
# Compatible avec la structure V2 existante

set -e

echo "ğŸš€ Configuration du Monitoring V3 pour Computer Vision Cats & Dogs"
echo "=================================================================="

# Couleurs pour output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# VÃ©rifier que les fichiers de config existent
echo -e "\n${YELLOW}ğŸ“‹ VÃ©rification des fichiers de configuration...${NC}"

required_files=(
    "docker/docker-compose.yml"
    "monitoring/prometheus/prometheus.yml"
    "monitoring/grafana/datasources/datasources.yml"
    ".env"
)

for file in "${required_files[@]}"; do
    if [ ! -f "$file" ]; then
        echo -e "${RED}âŒ Fichier manquant: $file${NC}"
        exit 1
    fi
    echo -e "${GREEN}âœ… $file${NC}"
done

# CrÃ©er les dossiers nÃ©cessaires
echo -e "\n${YELLOW}ğŸ“ CrÃ©ation des dossiers de donnÃ©es...${NC}"
mkdir -p data/{raw,processed,external}
mkdir -p monitoring/{prometheus/rules,grafana/dashboards,alertmanager}
echo -e "${GREEN}âœ… Dossiers crÃ©Ã©s${NC}"

# VÃ©rifier Docker
echo -e "\n${YELLOW}ğŸ³ VÃ©rification de Docker...${NC}"
if ! command -v docker &> /dev/null; then
    echo -e "${RED}âŒ Docker n'est pas installÃ©${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Docker installÃ©: $(docker --version)${NC}"

if ! command -v docker-compose &> /dev/null; then
    echo -e "${RED}âŒ Docker Compose n'est pas installÃ©${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Docker Compose installÃ©: $(docker-compose --version)${NC}"

# VÃ©rifier le fichier .env
echo -e "\n${YELLOW}ğŸ” VÃ©rification des variables d'environnement...${NC}"
source .env
required_vars=("DB_PWD" "API_TOKEN")
for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo -e "${RED}âŒ Variable manquante: $var${NC}"
        echo "   Veuillez configurer .env"
        exit 1
    fi
    echo -e "${GREEN}âœ… $var configurÃ©e${NC}"
done

# DÃ©marrer les services
echo -e "\n${YELLOW}ğŸš€ DÃ©marrage des services Docker...${NC}"
cd docker
docker-compose up -d

# Attendre que les services soient prÃªts
echo -e "\n${YELLOW}â³ Attente du dÃ©marrage des services (30s)...${NC}"
sleep 30

# VÃ©rifier l'Ã©tat des services
echo -e "\n${YELLOW}ğŸ” VÃ©rification des services...${NC}"

services=("cv_postgres" "cv_cats_dogs_app" "cv_prometheus" "cv_grafana")
for service in "${services[@]}"; do
    if docker ps --filter "name=$service" --filter "status=running" | grep -q "$service"; then
        echo -e "${GREEN}âœ… $service: Running${NC}"
    else
        echo -e "${RED}âŒ $service: Not running${NC}"
        docker logs "$service" --tail 20
    fi
done

# Tester les endpoints
echo -e "\n${YELLOW}ğŸŒ Test des endpoints...${NC}"

endpoints=(
    "http://localhost:8000/health|API Health"
    "http://localhost:8000/docs|API Documentation"
    "http://localhost:8000/monitoring|Dashboard V2 (Plotly)"
    "http://localhost:9090/-/healthy|Prometheus"
    "http://localhost:3000/api/health|Grafana"
)

for endpoint in "${endpoints[@]}"; do
    IFS='|' read -r url name <<< "$endpoint"
    if curl -s -f "$url" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… $name: $url${NC}"
    else
        echo -e "${RED}âŒ $name: $url (non accessible)${NC}"
    fi
done

# Configuration Grafana automatique
echo -e "\n${YELLOW}ğŸ“Š Configuration initiale de Grafana...${NC}"
GRAFANA_API="http://localhost:3000/api"
GRAFANA_USER="admin"
GRAFANA_PASS="${GRAFANA_PASSWORD:-admin}"

# Attendre que Grafana soit complÃ¨tement prÃªt
sleep 10

# CrÃ©er un dossier pour les dashboards
curl -s -X POST "$GRAFANA_API/folders" \
    -H "Content-Type: application/json" \
    -u "$GRAFANA_USER:$GRAFANA_PASS" \
    -d '{"title":"Computer Vision"}' > /dev/null 2>&1

echo -e "${GREEN}âœ… Grafana configurÃ©${NC}"

# Afficher le rÃ©sumÃ©
echo -e "\n${GREEN}========================================${NC}"
echo -e "${GREEN}âœ… Configuration terminÃ©e avec succÃ¨s !${NC}"
echo -e "${GREEN}========================================${NC}"

echo -e "\nğŸ“Œ ${YELLOW}URLs des services:${NC}"
echo -e "   ğŸš€ API FastAPI:        http://localhost:8000"
echo -e "   ğŸ“š API Docs (Swagger): http://localhost:8000/docs"
echo -e "   ğŸ“ˆ Dashboard V2:       http://localhost:8000/monitoring"
echo -e "   ğŸ“Š Grafana V3:         http://localhost:3000 (admin/${GRAFANA_PASSWORD:-admin})"
echo -e "   ğŸ” Prometheus:         http://localhost:9090"

echo -e "\nğŸ“ ${YELLOW}Prochaines Ã©tapes:${NC}"
echo "   1. AccÃ©der Ã  Grafana: http://localhost:3000"
echo "   2. Importer le dashboard CV depuis monitoring/grafana/dashboards/"
echo "   3. Configurer le webhook Discord dans .env"
echo "   4. Tester une prÃ©diction: http://localhost:8000"

echo -e "\nğŸ’¡ ${YELLOW}Commandes utiles:${NC}"
echo "   make docker-logs    # Voir les logs"
echo "   make docker-down    # ArrÃªter les services"
echo "   make docker-restart # RedÃ©marrer les services"

echo -e "\nâœ¨ Monitoring V3 opÃ©rationnel !"