#!/bin/bash

# Script de dÃ©ploiement automatique sur serveur de test
# UtilisÃ© par GitHub Actions et dÃ©ploiement manuel

set -e

echo "ğŸš€ DÃ©ploiement Computer Vision V3"
echo "=================================="

# Configuration
SERVER_USER="${TEST_SERVER_USER:-deploy}"
SERVER_HOST="${TEST_SERVER_HOST}"
DEPLOY_PATH="/opt/cv-cats-dogs-v3"

if [ -z "$SERVER_HOST" ]; then
    echo "âŒ Erreur: TEST_SERVER_HOST non dÃ©fini"
    exit 1
fi

echo "ğŸ“¡ Serveur cible: $SERVER_USER@$SERVER_HOST"
echo "ğŸ“ Chemin de dÃ©ploiement: $DEPLOY_PATH"

# Fonction pour exÃ©cuter des commandes SSH
run_ssh() {
    ssh "$SERVER_USER@$SERVER_HOST" "$1"
}

# VÃ©rifier la connexion SSH
echo -e "\nğŸ” Test de connexion SSH..."
if ! run_ssh "echo 'Connexion OK'"; then
    echo "âŒ Impossible de se connecter au serveur"
    exit 1
fi
echo "âœ… Connexion SSH Ã©tablie"

# CrÃ©er le dossier de dÃ©ploiement si nÃ©cessaire
echo -e "\nğŸ“ PrÃ©paration du dossier de dÃ©ploiement..."
run_ssh "mkdir -p $DEPLOY_PATH"

# Sync du code (exclure les donnÃ©es sensibles)
echo -e "\nğŸ“¦ Synchronisation du code..."
rsync -avz --delete \
    --exclude 'data/' \
    --exclude '.git/' \
    --exclude '__pycache__/' \
    --exclude '*.pyc' \
    --exclude '.env' \
    --exclude 'notebooks/' \
    ./ "$SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/"

echo "âœ… Code synchronisÃ©"

# Copier le fichier .env (si existe localement)
if [ -f ".env" ]; then
    echo -e "\nğŸ” Copie du fichier .env..."
    scp .env "$SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/.env"
    echo "âœ… Fichier .env copiÃ©"
else
    echo "âš ï¸  Pas de fichier .env local, assurez-vous qu'il existe sur le serveur"
fi

# ArrÃªter les anciens containers
echo -e "\nğŸ›‘ ArrÃªt des anciens services..."
run_ssh "cd $DEPLOY_PATH && docker-compose -f docker/docker-compose.yml down || true"

# Pull des nouvelles images
echo -e "\nğŸ“¥ TÃ©lÃ©chargement des images Docker..."
run_ssh "cd $DEPLOY_PATH && docker-compose -f docker/docker-compose.yml pull"

# DÃ©marrer les nouveaux services
echo -e "\nğŸš€ DÃ©marrage des nouveaux services..."
run_ssh "cd $DEPLOY_PATH && docker-compose -f docker/docker-compose.yml up -d"

# Attendre que les services soient prÃªts
echo -e "\nâ³ Attente du dÃ©marrage des services (45s)..."
sleep 45

# VÃ©rifier l'Ã©tat des services
echo -e "\nğŸ” VÃ©rification des services..."
run_ssh "cd $DEPLOY_PATH && docker-compose -f docker/docker-compose.yml ps"

# Test de santÃ© de l'API
echo -e "\nğŸ¥ Test de santÃ© de l'API..."
if run_ssh "curl -f http://localhost:8000/health"; then
    echo -e "\nâœ… API opÃ©rationnelle"
else
    echo -e "\nâŒ API non accessible"
    echo "Logs de l'application:"
    run_ssh "cd $DEPLOY_PATH && docker-compose -f docker/docker-compose.yml logs --tail 50 cv_app"
    exit 1
fi

# Afficher les URLs
echo -e "\n${GREEN}========================================${NC}"
echo "âœ… DÃ©ploiement rÃ©ussi !"
echo "========================================"
echo ""
echo "ğŸ“Œ URLs des services:"
echo "   ğŸš€ API:        http://$SERVER_HOST:8000"
echo "   ğŸ“š API Docs:   http://$SERVER_HOST:8000/docs"
echo "   ğŸ“ˆ Dashboard:  http://$SERVER_HOST:8000/monitoring"
echo "   ğŸ“Š Grafana:    http://$SERVER_HOST:3000"
echo "   ğŸ” Prometheus: http://$SERVER_HOST:9090"

echo -e "\nğŸ’¡ Commandes utiles sur le serveur:"
echo "   ssh $SERVER_USER@$SERVER_HOST"
echo "   cd $DEPLOY_PATH"
echo "   docker-compose -f docker/docker-compose.yml logs -f"

echo -e "\nâœ¨ DÃ©ploiement terminÃ© avec succÃ¨s !"